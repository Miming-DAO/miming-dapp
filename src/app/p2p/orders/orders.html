<div class="max-w-7xl mx-auto">
  <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-8">

    <!-- ************ -->
    <!-- Panel Header -->
    <!-- ************ -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl md:text-2xl font-bold text-white mb-1 md:mb-2">Order History</h2>
        <p class="text-sm md:text-base text-slate-400">Track your P2P transactions</p>
      </div>

      <!-- View Toggle (My Orders vs My Ad Orders) -->
      <div class="flex gap-2">
        <button (click)="activeViewTab = 'my-orders'"
          [class]="activeViewTab === 'my-orders' ? 'bg-linear-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700/50'"
          class="flex-1 sm:flex-none px-4 md:px-6 py-2.5 md:py-3 rounded-3xl font-bold text-sm md:text-base transition-all duration-200 cursor-pointer flex items-center justify-center gap-2">
          <i class="pi pi-shopping-bag"></i>
          <span class="hidden sm:inline">My Orders</span>
          <span class="sm:hidden">Mine</span>
        </button>

        <button (click)="activeViewTab = 'my-ad-orders'"
          [class]="activeViewTab === 'my-ad-orders' ? 'bg-linear-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700/50'"
          class="flex-1 sm:flex-none px-4 md:px-6 py-2.5 md:py-3 rounded-3xl font-bold text-sm md:text-base transition-all duration-200 cursor-pointer flex items-center justify-center gap-2">
          <i class="pi pi-briefcase"></i>
          <span class="hidden sm:inline">My Ad Orders</span>
          <span class="sm:hidden">Ads</span>
        </button>
      </div>
    </div>

    <!-- ******* -->
    <!-- Filters -->
    <!-- ******* -->
    <div class="flex flex-col md:flex-row gap-3 mb-6">
      <div class="w-full md:w-56">
        <p-select [options]="statusOptions" [(ngModel)]="activeStatusTab" placeholder="Filter by Status"
          optionLabel="label" optionValue="value" class="w-full" size="large">
          <ng-template #selectedItem let-selectedOption>
            @if (selectedOption) {
            <div class="flex items-center gap-2">
              <i [class]="selectedOption.icon" class="text-sm"></i>
              <span class="font-medium">{{ selectedOption.label }}</span>
            </div>
            }
          </ng-template>
          <ng-template let-status #item>
            <div class="flex items-center gap-2 py-1">
              <i [class]="status.icon" class="text-sm"></i>
              <span class="font-medium">{{ status.label }}</span>
            </div>
          </ng-template>
        </p-select>
      </div>

      <div class="flex-1">
        <input type="text" [(ngModel)]="searchTerm" placeholder="Search by order number, user, or amount..."
          class="w-full px-4 py-3 rounded-3xl bg-slate-800/50 border border-gray-100/30 text-white placeholder:text-slate-500 outline-none focus:border-purple-500/50 transition-all" />
      </div>
    </div>

    <!-- ************* -->
    <!-- Loading State -->
    <!-- ************* -->
    @if (isLoading) {
    <div class="flex justify-center items-center py-12">
      <div class="flex flex-col items-center gap-4">
        <i class="pi pi-spin pi-spinner text-4xl text-purple-400"></i>
        <p class="text-slate-400">Loading orders...</p>
      </div>
    </div>
    }

    <!-- *********** -->
    <!-- Empty State -->
    <!-- *********** -->
    @if (!isLoading && filteredOrders.length === 0) {
    <div class="text-center py-12">
      <div class="w-20 h-20 mx-auto mb-4 rounded-3xl bg-purple-500/10 flex items-center justify-center">
        <i [class]="activeViewTab === 'my-orders' ? 'pi pi-shopping-bag' : 'pi pi-briefcase'"
          class="text-4xl text-purple-400"></i>
      </div>
      <h3 class="text-xl font-semibold text-white mb-2">No {{ activeStatusTab === 'in-progress' ? 'In Progress' :
        activeStatusTab }} Orders</h3>
      <p class="text-slate-400 mb-6">
        @if (activeViewTab === 'my-orders') {
        You don't have any {{ activeStatusTab === 'in-progress' ? 'in progress' : activeStatusTab }} orders at the
        moment
        } @else {
        No one has placed {{ activeStatusTab === 'in-progress' ? 'in progress' : activeStatusTab }} orders on your ads
        yet
        }
      </p>
      <button (click)="loadOrders()"
        class="px-6 py-3 rounded-3xl bg-linear-to-r from-purple-600 to-pink-600 text-white font-bold hover:scale-105 transition-all duration-200 shadow-sm cursor-pointer">
        <i class="pi pi-refresh mr-2"></i>
        Refresh
      </button>
    </div>
    }

    <!-- ********** -->
    <!-- Order List -->
    <!-- ********** -->
    @if (!isLoading && filteredOrders.length > 0) {

    <!-- ****************** -->
    <!-- Desktop Table View -->
    <!-- ****************** -->
    <div
      class="hidden md:block backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full min-w-max">
          <thead>
            <tr class="border-b border-slate-700">
              <th class="text-left py-3 px-4 text-sm font-semibold text-slate-400">Order</th>
              <th class="text-left py-3 px-4 text-sm font-semibold text-slate-400 hidden lg:table-cell">Date</th>
              <th class="text-right py-3 px-4 text-sm font-semibold text-slate-400">Price</th>
              <th class="text-right py-3 px-4 text-sm font-semibold text-slate-400 hidden xl:table-cell">Quantity</th>
              <th class="text-right py-3 px-4 text-sm font-semibold text-slate-400">Amount</th>
              <th class="text-left py-3 px-4 text-sm font-semibold text-slate-400 hidden lg:table-cell">Payment</th>
              <th class="text-left py-3 px-4 text-sm font-semibold text-slate-400">Status</th>
              <th class="text-center py-3 px-4 text-sm font-semibold text-slate-400">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (order of filteredOrders; track order.id) {
            <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition-colors">

              <!-- ********************* -->
              <!-- Order Number + Ad Info -->
              <!-- ********************* -->
              <td class="py-4 px-4">
                <div class="flex items-center gap-3">
                  <div
                    [class]="order.p2p_ad?.type === 'buy' ? 'bg-linear-to-r from-green-500 to-green-600' : 'bg-linear-to-r from-purple-600 to-pink-600'"
                    class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0">
                    <i [class]="order.p2p_ad?.type === 'buy' ? 'pi pi-arrow-down' : 'pi pi-arrow-up'"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-semibold text-white truncate">{{ order.order_number }}</div>
                    <div class="text-xs text-slate-400 mt-0.5 truncate">{{ order.p2p_ad?.name }}</div>
                    <span
                      [class]="order.p2p_ad?.type === 'buy' ? 'bg-green-500/20 text-green-300 border-green-500/30' : 'bg-purple-500/20 text-purple-300 border-purple-500/30'"
                      class="inline-block mt-1 px-2 py-0.5 rounded-full text-xs font-semibold border uppercase lg:hidden">
                      <i [class]="order.p2p_ad?.type === 'buy' ? 'pi pi-arrow-down' : 'pi pi-arrow-up'"
                        class="mr-1"></i>
                      {{ order.p2p_ad?.type }}
                    </span>
                  </div>
                </div>
              </td>

              <!-- ************ -->
              <!-- Date Column -->
              <!-- ************ -->
              <td class="py-4 px-4 hidden lg:table-cell">
                <div class="text-sm text-slate-300">{{ order.created_at | date:'MMM d, y' }}</div>
                <div class="text-xs text-slate-400 mt-1">{{ order.created_at | date:'h:mm a' }}</div>
              </td>

              <!-- ************ -->
              <!-- Price Column -->
              <!-- ************ -->
              <td class="py-4 px-4 text-right">
                <div class="font-bold text-base text-slate-200 whitespace-nowrap">
                  ${{ order.ordered_price | number:'1.2-2' }}
                </div>
                <div class="text-xs text-slate-400 mt-0.5">per unit</div>
              </td>

              <!-- **************** -->
              <!-- Quantity Column -->
              <!-- **************** -->
              <td class="py-4 px-4 text-right hidden xl:table-cell">
                <div class="font-semibold text-white">{{ order.quantity | number:'1.2-6' }}</div>
                <div class="text-xs text-slate-400">USDT</div>
              </td>

              <!-- ************* -->
              <!-- Amount Column -->
              <!-- ************* -->
              <td class="py-4 px-4 text-right">
                <div
                  class="font-bold text-lg bg-linear-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent whitespace-nowrap">
                  ${{ order.amount | number:'1.2-2' }}
                </div>
              </td>

              <!-- ************** -->
              <!-- Payment Method -->
              <!-- ************** -->
              <td class="py-4 px-4 hidden lg:table-cell">
                <div class="flex items-center gap-2">
                  @if (order.p2p_payment_type?.logo_url) {
                  <img [src]="order.p2p_payment_type!.logo_url" [alt]="order.p2p_payment_type!.name"
                    class="w-5 h-5 object-contain" />
                  } @else {
                  <div class="w-5 h-5 rounded-full bg-purple-500/20 flex items-center justify-center">
                    <i class="pi pi-wallet text-purple-400 text-xs"></i>
                  </div>
                  }
                  <span class="text-sm text-slate-300">{{ order.p2p_payment_type?.name || 'N/A' }}</span>
                </div>
              </td>

              <!-- ****** -->
              <!-- Status -->
              <!-- ****** -->
              <td class="py-4 px-4">
                <span [class]="getStatusBadgeClass(order.status)"
                  class="px-2 py-1 rounded-full text-xs font-semibold border uppercase inline-block">
                  {{ order.status }}
                </span>
              </td>

              <!-- ******* -->
              <!-- Actions -->
              <!-- ******* -->
              <td class="py-4 px-4">
                <div class="flex items-center justify-center">
                  <button (click)="openOrderDetails(order)" title="View Details"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 transition-all cursor-pointer">
                    <i class="pi pi-eye text-sm"></i>
                  </button>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- **************** -->
    <!-- Mobile Card View -->
    <!-- **************** -->
    <div class="md:hidden space-y-3">
      @for (order of filteredOrders; track order.id) {
      <div
        class="backdrop-blur-xl bg-linear-to-br from-slate-800/80 via-purple-900/30 to-slate-800/90 rounded-3xl border border-purple-500/20 p-4 hover:border-purple-500/40 transition-all duration-200"
        (click)="openOrderDetails(order)">

        <!-- **************************** -->
        <!-- Header: Type Badge + Status -->
        <!-- **************************** -->
        <div class="flex items-center justify-between mb-3">
          <span
            [class]="order.p2p_ad?.type === 'buy' ? 'bg-green-500/20 text-green-300 border-green-500/30' : 'bg-purple-500/20 text-purple-300 border-purple-500/30'"
            class="px-3 py-1 rounded-full text-xs font-bold border uppercase">
            <i [class]="order.p2p_ad?.type === 'buy' ? 'pi pi-arrow-down' : 'pi pi-arrow-up'" class="mr-1"></i>
            {{ order.p2p_ad?.type }}
          </span>
          <span [class]="getStatusBadgeClass(order.status)"
            class="px-2 py-1 rounded-full text-xs font-semibold border uppercase">
            {{ order.status }}
          </span>
        </div>

        <!-- ******************* -->
        <!-- Order Number + Name -->
        <!-- ******************* -->
        <div class="flex items-center gap-3 mb-3 px-2">
          <div
            [class]="order.p2p_ad?.type === 'buy' ? 'bg-linear-to-r from-green-500 to-green-600' : 'bg-linear-to-r from-purple-600 to-pink-600'"
            class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold shrink-0">
            <i [class]="order.p2p_ad?.type === 'buy' ? 'pi pi-arrow-down' : 'pi pi-arrow-up'"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h3 class="font-bold text-white truncate">{{ order.order_number }}</h3>
            <p class="text-xs text-slate-400 truncate">{{ order.p2p_ad?.name }}</p>
            <p class="text-xs text-slate-400">{{ order.created_at | date:'MMM d, y h:mm a' }}</p>
          </div>
        </div>

        <!-- ************** -->
        <!-- Price & Amount -->
        <!-- ************** -->
        <div class="border-b border-slate-700/50 mb-3 pb-3">
          <div class="flex items-center justify-between px-2 mb-2">
            <span class="text-xs text-slate-400">Unit Price</span>
            <div class="font-bold text-base text-slate-200">
              ${{ order.ordered_price | number:'1.2-2' }}
            </div>
          </div>
          <div class="flex items-center justify-between px-2">
            <span class="text-xs text-slate-400">Total Amount</span>
            <div class="font-bold text-xl bg-linear-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
              ${{ order.amount | number:'1.2-2' }}
            </div>
          </div>
        </div>

        <!-- ********* -->
        <!-- Info Grid -->
        <!-- ********* -->
        <div class="space-y-2 mb-3">
          <div class="flex justify-between px-2">
            <span class="text-xs text-slate-400">Quantity</span>
            <div class="text-white font-bold text-sm text-right">{{ order.quantity | number:'1.2-6' }} USDT</div>
          </div>
          <div class="flex justify-between px-2">
            <span class="text-xs text-slate-400">Payment Method</span>
            <div class="flex items-center gap-1.5">
              @if (order.p2p_payment_type?.logo_url) {
              <img [src]="order.p2p_payment_type!.logo_url" [alt]="order.p2p_payment_type!.name"
                class="w-4 h-4 object-contain" />
              }
              <span class="text-white font-bold text-sm">{{ order.p2p_payment_type?.name || 'N/A' }}</span>
            </div>
          </div>
        </div>
      </div>
      }
    </div>

    }
  </div>
</div>

<!-- ********************************************** -->
<!-- Upload Proof of Payment Dialog                -->
<!-- ********************************************** -->
<p-dialog [(visible)]="showPaymentProofDialog" [modal]="true" [closable]="true" [draggable]="false"
  [style]="{ width: '95vw', maxWidth: '500px', 'border-radius': '1.5rem'  }">
  <ng-template #header>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-linear-to-r from-yellow-500 to-orange-500 flex items-center justify-center">
        <i class="pi pi-upload text-white text-lg"></i>
      </div>
      <span class="text-lg font-bold text-white">Upload Proof of Payment</span>
    </div>
  </ng-template>

  <div class="space-y-5 py-4">
    <!-- Payment Information -->
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="space-y-3 text-sm">
        <div class="flex justify-between items-center">
          <span class="text-slate-400">Amount to Pay</span>
          <span class="text-white font-bold text-lg">${{ selectedOrder?.amount | number:'1.2-2' }} USD</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-slate-400">You Will Receive</span>
          <span class="text-white font-semibold">{{ selectedOrder?.quantity | number:'1.2-6' }} USDT</span>
        </div>
      </div>
    </div>

    <!-- File Upload Area -->
    <div class="space-y-2">
      <label class="text-sm font-semibold text-white">Payment Proof (Screenshot/Receipt)</label>
      <div class="relative">
        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*,.pdf" class="hidden" />
        <div (click)="fileInput.click()"
          class="border-2 border-dashed border-slate-600 rounded-3xl p-8 text-center cursor-pointer hover:border-purple-500/50 hover:bg-purple-500/5 transition-all duration-200">
          @if (!selectedFile) {
          <div class="space-y-3">
            <i class="pi pi-cloud-upload text-4xl text-slate-500"></i>
            <div class="space-y-1">
              <p class="text-white font-semibold">Click to upload</p>
              <p class="text-xs text-slate-400">PNG, JPG, PDF up to 10MB</p>
            </div>
          </div>
          } @else {
          <div class="space-y-2">
            <i class="pi pi-file text-3xl text-green-400"></i>
            <p class="text-white font-semibold">{{ selectedFile.name }}</p>
            <p class="text-xs text-slate-400">{{ (selectedFile.size / 1024).toFixed(2) }} KB</p>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Reference Number (Optional) -->
    <div class="space-y-2">
      <label class="text-sm font-semibold text-white">Transaction Reference (Optional)</label>
      <input type="text" [(ngModel)]="paymentReference" pInputText placeholder="Enter transaction reference number"
        class="w-full px-4 py-3 rounded-3xl bg-slate-800/50 border border-slate-700/50 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500/50 focus:bg-slate-800" />
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 pt-2">
      <button type="button" (click)="uploadPaymentProof()" [disabled]="!selectedFile" [class.opacity-50]="!selectedFile"
        [class.cursor-not-allowed]="!selectedFile"
        class="flex-1 px-6 py-3.5 rounded-3xl bg-linear-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold transition-all duration-200 cursor-pointer flex items-center justify-center gap-2 shadow-lg">
        <i class="pi pi-check"></i>
        <span>Submit Proof</span>
      </button>
      <button type="button" (click)="closePaymentProofDialog()"
        class="flex-1 px-6 py-3 rounded-3xl bg-slate-700/50 hover:bg-slate-600/50 text-white font-semibold transition-all duration-200 cursor-pointer">
        Cancel
      </button>
    </div>
  </div>
</p-dialog>

<!-- ***** -->
<!-- Toast -->
<!-- ***** -->
<p-toast />
