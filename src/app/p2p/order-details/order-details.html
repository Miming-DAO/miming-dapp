<div class="max-w-7xl mx-auto">

  <!-- Back Button & Header -->
  <div class="mb-4 md:mb-6">
    <button (click)="goBack()"
      class="inline-flex items-center gap-2 px-4 py-2 rounded-3xl bg-slate-800/50 hover:bg-slate-700/50 text-slate-300 hover:text-white border border-slate-700/50 transition-all duration-200 cursor-pointer">
      <i class="pi pi-arrow-left"></i>
      <span class="text-sm font-medium">Back to Orders</span>
    </button>
  </div>

  @if (isLoading) {
  <div class="flex justify-center items-center py-20">
    <div class="flex flex-col items-center gap-4">
      <i class="pi pi-spin pi-spinner text-5xl text-purple-400"></i>
      <p class="text-slate-400">Loading order details...</p>
    </div>
  </div>
  }

  @if (!isLoading && p2pOrder) {

  <!-- Mobile: Chat-first view with button to show order details in dialog -->
  <div class="lg:hidden">

    <!-- Mobile Header with Order Details Button -->
    <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 mb-4">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <div
            [class]="p2pOrder.order_type === 'buy' ? 'bg-linear-to-r from-green-500 to-green-600' : 'bg-linear-to-r from-purple-600 to-pink-600'"
            class="w-10 h-10 rounded-full flex items-center justify-center shrink-0">
            <i class="pi pi-shopping-cart text-white"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h1 class="text-base font-bold text-white truncate">{{ p2pOrder.order_number }}</h1>
            <span
              [class]="p2pOrder.status === 'completed' ? 'bg-green-500/20 text-green-400 border-green-500/30' : p2pOrder.status === 'cancelled' ? 'bg-red-500/20 text-red-400 border-red-500/30' : p2pOrder.status === 'paid' ? 'bg-blue-500/20 text-blue-400 border-blue-500/30' : 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30'"
              class="inline-block px-2 py-1 rounded-full text-xs font-bold border uppercase">
              {{ p2pOrder.status }}
            </span>
          </div>
        </div>
        <button (click)="showMobileOrderDetailsDialog = true" type="button"
          class="px-3 py-2 rounded-3xl bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium transition-all duration-200 shrink-0 cursor-pointer">
          <i class="pi pi-info-circle mr-1.5"></i>
          Details
        </button>
      </div>
    </div>

    <!-- Status-Specific Information (Mobile) -->
    <div
      [class]="'backdrop-blur-xl border-2 rounded-3xl p-4 mb-4 bg-' + statusColorClass + '-500/10 border-' + statusColorClass + '-500/30'">
      <div class="flex items-start gap-3">
        <div
          [class]="'w-10 h-10 rounded-full flex items-center justify-center shrink-0 bg-linear-to-r from-' + statusColorClass + '-500 to-' + statusColorClass + '-600'">
          <i [class]="'pi text-white ' + statusIcon"></i>
        </div>
        <div class="flex-1 space-y-1">
          <h3 class="text-base font-bold text-white">{{ statusTitle }}</h3>
          <p class="text-sm text-slate-300 leading-relaxed" [innerHTML]="statusMessage"></p>
        </div>
      </div>
    </div>

    <!-- Mobile Chat -->
    <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 overflow-hidden">
      <!-- Chat Header with Merchant Info -->
      <div class="p-4 border-b border-slate-700/50 bg-slate-900/50">
        <div class="flex items-center gap-3">
          @if (p2pOrder.p2p_ad?.logo_url) {
          <img [src]="p2pOrder.p2p_ad?.logo_url" [alt]="p2pOrder.p2p_ad?.name"
            class="w-10 h-10 rounded-full object-cover shrink-0" />
          } @else {
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-purple-500 to-pink-500 flex items-center justify-center shrink-0">
            <i class="pi pi-user text-white"></i>
          </div>
          }
          <div class="flex-1 min-w-0">
            <h3 class="text-base font-bold text-white truncate">{{ p2pOrder.p2p_ad?.name }}</h3>
            <div class="flex items-center gap-2">
              <img [src]="'/images/tokens/' + (p2pOrder.p2p_ad?.token_symbol || 'usdt').toLowerCase() + '.png'"
                [alt]="p2pOrder.p2p_ad?.token_symbol || 'USDT'" class="w-3.5 h-3.5 object-contain" />
              <span class="text-xs text-slate-400">{{ p2pOrder.p2p_ad?.token_symbol }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Messages -->
      <div class="chat-messages p-4 space-y-3 bg-slate-900/30"
        style="height: calc(100vh - 340px); max-height: calc(100vh - 340px);">
        @for (msg of chatMessages; track msg.timestamp) {
        @if (msg.sender === 'me') {

        <!-- My Message -->
        <div class="flex justify-end">
          <div class="max-w-[80%]">
            <div class="bg-linear-to-r from-purple-600 to-pink-600 rounded-3xl rounded-tr-sm p-3">
              <p class="text-sm text-white">{{ msg.message }}</p>
            </div>
            <p class="text-xs text-slate-500 mt-1 text-right">{{ formatMessageTime(msg.timestamp) }}</p>
          </div>
        </div>
        } @else {
        <!-- Other's Message -->
        <div class="flex justify-start">
          <div class="max-w-[80%]">
            <div class="flex items-center gap-2 mb-1">
              <div
                class="w-6 h-6 rounded-full bg-linear-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                <i class="pi pi-user text-white text-xs"></i>
              </div>
              <span class="text-xs font-medium text-slate-400">{{ msg.senderName }}</span>
            </div>
            <div class="bg-slate-700/50 rounded-3xl rounded-tl-sm p-3">
              <p class="text-sm text-slate-200">{{ msg.message }}</p>
            </div>
            <p class="text-xs text-slate-500 mt-1">{{ formatMessageTime(msg.timestamp) }}</p>
          </div>
        </div>
        }
        }

        @if (chatMessages.length === 0) {
        <div class="flex flex-col items-center justify-center h-full text-center">
          <i class="pi pi-comments text-4xl text-slate-600 mb-2"></i>
          <p class="text-sm text-slate-500">No messages yet</p>
          <p class="text-xs text-slate-600 mt-1">Start a conversation</p>
        </div>
        }
      </div>

      <!-- Chat Input -->
      @if (p2pOrder.status !== 'completed' && p2pOrder.status !== 'cancelled') {
      <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
        <div class="flex gap-2">
          <input type="text" [(ngModel)]="chatMessage" (keyup.enter)="sendMessage()" placeholder="Type a message..."
            class="flex-1 px-4 py-2.5 rounded-3xl bg-slate-800/50 border border-slate-700/50 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500/50 text-sm" />
          <button (click)="sendMessage()" [disabled]="!chatMessage || !chatMessage.trim()"
            [class.opacity-50]="!chatMessage || !chatMessage.trim()"
            [class.cursor-not-allowed]="!chatMessage || !chatMessage.trim()"
            class="px-4 py-2.5 rounded-3xl bg-linear-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white transition-all duration-200 cursor-pointer">
            <i class="pi pi-send"></i>
          </button>
        </div>
      </div>
      }
      @if (p2pOrder.status === 'completed' || p2pOrder.status === 'cancelled') {
      <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
        <div class="text-center py-2">
          <p class="text-xs text-slate-500">Chat is disabled for {{ p2pOrder.status }} orders</p>
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Desktop: Original 2-column layout -->
  <div class="hidden lg:grid lg:grid-cols-3 gap-4 md:gap-6">

    <!-- Left Column: Order Details (2/3 width on desktop) -->
    <div class="lg:col-span-2 space-y-4">

      <!-- Order Header Card -->
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
          <div>
            <div class="flex items-center gap-2 mb-2">
              <div
                [class]="p2pOrder.order_type === 'buy' ? 'bg-linear-to-r from-green-500 to-green-600' : 'bg-linear-to-r from-purple-600 to-pink-600'"
                class="w-10 h-10 rounded-full flex items-center justify-center">
                <i class="pi pi-shopping-cart text-white"></i>
              </div>
              <div>
                <h1 class="text-lg md:text-xl font-bold text-white">{{ p2pOrder.order_number }}</h1>
                <p class="text-xs text-slate-400">{{ p2pOrder.created_at | date:'medium' }}</p>
              </div>
            </div>
          </div>

          <div>
            <span
              [class]="p2pOrder.status === 'completed' ? 'bg-green-500/20 text-green-400 border-green-500/30' : p2pOrder.status === 'cancelled' ? 'bg-red-500/20 text-red-400 border-red-500/30' : p2pOrder.status === 'paid' ? 'bg-blue-500/20 text-blue-400 border-blue-500/30' : 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30'"
              class="px-4 py-2 rounded-full text-sm font-bold border uppercase">
              {{ p2pOrder.status }}
            </span>
          </div>
        </div>

        <!-- Order Type Badge -->
        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-700/30 border border-slate-600/30">
          <i
            [class]="p2pOrder.order_type === 'buy' ? 'pi pi-arrow-down text-green-400' : 'pi pi-arrow-up text-purple-400'"></i>
          <span class="text-sm font-semibold text-white uppercase">{{ p2pOrder.order_type }}</span>
        </div>
      </div>

      <!-- Status-Specific Information -->
      <div
        [class]="'backdrop-blur-xl border-2 rounded-3xl p-5 md:p-6 bg-' + statusColorClass + '-500/10 border-' + statusColorClass + '-500/30'">
        <div class="flex items-start gap-3 md:gap-4">
          <div
            [class]="'w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-linear-to-r from-' + statusColorClass + '-500 to-' + statusColorClass + '-600'">
            <i [class]="'text-white text-xl pi ' + statusIcon"></i>
          </div>
          <div class="flex-1 space-y-2">
            <h3 class="text-lg font-bold text-white">{{ statusTitle }}</h3>
            <p class="text-sm text-slate-300 leading-relaxed" [innerHTML]="statusMessage"></p>
          </div>
        </div>
      </div>

      <!-- Order Details with Merchant Info -->
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
            <i class="pi pi-file-edit text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-white">
              Order Details
            </h3>
            <p class="text-xs text-slate-300 leading-relaxed">
              Comprehensive details of the order including price, quantity, total amount, and payment method.
            </p>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="space-y-1">
            <p class="text-xs text-slate-400">Price per Token</p>
            <p class="text-lg font-bold text-white">${{ p2pOrder.ordered_price | number:'1.2-2' }}</p>
          </div>

          <div class="space-y-1">
            <p class="text-xs text-slate-400">Quantity</p>
            <p class="text-lg font-bold text-white">
              {{ p2pOrder.quantity | number:'1.2-6' }} {{ p2pOrder.p2p_ad?.token_symbol }}
            </p>
          </div>

          <div class="space-y-1">
            <p class="text-xs text-slate-400">Total Amount</p>
            <p class="text-xl font-bold bg-linear-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
              ₱{{ p2pOrder.amount | number:'1.2-2' }} PHP
            </p>
          </div>

          <div class="space-y-1">
            <p class="text-xs text-slate-400">Payment Method</p>
            <div class="flex items-center gap-2">
              @if (p2pOrder.p2p_payment_type?.logo_url) {
              <img [src]="p2pOrder.p2p_payment_type!.logo_url" [alt]="p2pOrder.p2p_payment_type!.name"
                class="w-5 h-5 object-contain" />
              }
              <p class="text-base font-semibold text-white">{{ p2pOrder.p2p_payment_type?.name || 'N/A' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- MERCHANT + BUY ORDER: User's USDT Delivery Address -->
      @if (isMerchant && p2pOrder.order_type === 'buy' && p2pOrder.wallet_address) {
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
            <i class="pi pi-wallet text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-white">User's {{ p2pOrder.p2p_ad?.token_symbol }} Delivery Address</h3>
            <p class="text-xs text-slate-300 leading-relaxed">User's wallet address to send the tokens</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-purple-500/20">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Wallet
                  Address</label>
                <p class="text-sm md:text-base font-mono text-white break-all leading-relaxed">
                  {{ p2pOrder.wallet_address }}
                </p>
              </div>
              <button type="button" (click)="copyToClipboard(p2pOrder.wallet_address, 'Wallet address')"
                class="shrink-0 w-10 h-10 rounded-full bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
              </button>
            </div>
          </div>

          <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-3">
            <div class="flex items-start gap-2">
              <i class="pi pi-info-circle text-blue-400 text-sm mt-0.5 shrink-0"></i>
              <p class="text-xs text-slate-300 leading-relaxed">
                <strong class="text-blue-300">Important:</strong> Send exactly <strong class="text-white">{{
                  p2pOrder.quantity | number:'1.2-6' }} {{ p2pOrder.p2p_ad?.token_symbol }}</strong> to this address.
              </p>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- MERCHANT + SELL ORDER: User's Payment Details -->
      @if (isMerchant && p2pOrder.order_type === 'sell' && (p2pOrder.account_name || p2pOrder.account_number)) {
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
            <i class="pi pi-credit-card text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-white">User's Payment Details</h3>
            <p class="text-xs text-slate-300 leading-relaxed">User's account details to send payment</p>
          </div>
        </div>

        <div class="space-y-3">
          @if (p2pOrder.account_name) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-purple-500/20">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Account
                  Name</label>
                <p class="text-sm md:text-base font-semibold text-white">
                  {{ p2pOrder.account_name }}
                </p>
              </div>
              <button type="button" (click)="copyToClipboard(p2pOrder.account_name, 'Account name')"
                class="shrink-0 w-10 h-10 rounded-full bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
              </button>
            </div>
          </div>
          }

          @if (p2pOrder.account_number) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-purple-500/20">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Account Number /
                  Mobile Number</label>
                <p class="text-sm md:text-base font-mono text-white tracking-wide">
                  {{ p2pOrder.account_number }}
                </p>
              </div>
              <button type="button" (click)="copyToClipboard(p2pOrder.account_number, 'Account number')"
                class="shrink-0 w-10 h-10 rounded-full bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
              </button>
            </div>
          </div>
          }

          @if (p2pOrder.p2p_payment_type?.name) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-purple-500/20">
            <div class="flex items-center gap-3">
              @if (p2pOrder.p2p_payment_type?.logo_url) {
              <img [src]="p2pOrder.p2p_payment_type!.logo_url" [alt]="p2pOrder.p2p_payment_type!.name"
                class="w-8 h-8 object-contain shrink-0" />
              }
              <div class="flex-1">
                <label class="text-xs text-green-400 font-semibold mb-1 block uppercase tracking-wide">Payment
                  Method</label>
                <p class="text-sm md:text-base font-semibold text-white">
                  {{ p2pOrder.p2p_payment_type?.name }}
                </p>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- USER + BUY ORDER: Merchant's Payment Details -->
      @if (isUser && p2pOrder.order_type === 'buy' && selectedAdPaymentType) {
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
            <i class="pi pi-credit-card text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-white">Merchant's Payment Details</h3>
            <p class="text-xs text-slate-300 leading-relaxed">Send your payment to this merchant account</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-purple-500/20">
            <div class="space-y-3">
              @if (selectedAdPaymentType.p2p_payment_type?.name) {
              <div class="flex items-center gap-3 pb-3 border-b border-slate-700/50">
                @if (selectedAdPaymentType.p2p_payment_type?.logo_url) {
                <img [src]="selectedAdPaymentType.p2p_payment_type!.logo_url"
                  [alt]="selectedAdPaymentType.p2p_payment_type!.name" class="w-8 h-8 object-contain shrink-0" />
                }
                <div class="flex-1">
                  <label class="text-xs text-purple-400 font-semibold block uppercase tracking-wide">Payment
                    Method</label>
                  <p class="text-sm md:text-base font-semibold text-white">
                    {{ selectedAdPaymentType.p2p_payment_type?.name }}
                  </p>
                </div>
              </div>
              }

              @if (selectedAdPaymentType.account_name) {
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                  <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Account
                    Name</label>
                  <p class="text-sm md:text-base font-semibold text-white">
                    {{ selectedAdPaymentType.account_name }}
                  </p>
                </div>
                <button type="button" (click)="copyToClipboard(selectedAdPaymentType.account_name, 'Account name')"
                  class="shrink-0 w-10 h-10 rounded-full bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                  <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
                </button>
              </div>
              }

              @if (selectedAdPaymentType.account_number) {
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                  <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Account Number
                    / Mobile</label>
                  <p class="text-sm md:text-base font-mono text-white tracking-wide">
                    {{ selectedAdPaymentType.account_number }}
                  </p>
                </div>
                <button type="button" (click)="copyToClipboard(selectedAdPaymentType.account_number, 'Account number')"
                  class="shrink-0 w-10 h-10 rounded-full bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                  <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
                </button>
              </div>
              }

              @if (selectedAdPaymentType.other_details) {
              <div>
                <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Other
                  Details</label>
                <p class="text-sm text-slate-300 leading-relaxed">
                  {{ selectedAdPaymentType.other_details }}
                </p>
              </div>
              }
            </div>
          </div>

          <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-3">
            <div class="flex items-start gap-2">
              <i class="pi pi-info-circle text-blue-400 text-sm mt-0.5 shrink-0"></i>
              <p class="text-xs text-slate-300 leading-relaxed">
                <strong class="text-blue-300">Important:</strong> Send exactly <strong class="text-white">₱{{
                  p2pOrder.amount | number:'1.2-2' }}</strong> to this payment account. Upload your proof of payment
                after sending.
              </p>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- USER + SELL ORDER: Merchant's Wallet Addresses -->
      @if (isUser && p2pOrder.order_type === 'sell' && adWalletAddresses.length > 0) {
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
            <i class="pi pi-wallet text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-white">Merchant's Wallet Addresses</h3>
            <p class="text-xs text-slate-300 leading-relaxed">
              Send your {{ p2pOrder.p2p_ad?.token_symbol }} tokens to one of these merchant wallets
            </p>
          </div>
        </div>

        <div class="space-y-3">
          @for (walletAddr of adWalletAddresses; track walletAddr.id) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-purple-500/20">
            <div class="space-y-3">
              @if (walletAddr.wallet_name) {
              <div class="pb-3 border-b border-slate-700/50">
                <label class="text-xs text-purple-400 font-semibold block uppercase tracking-wide mb-1">Wallet
                  Name</label>
                <p class="text-sm md:text-base font-semibold text-white">
                  {{ walletAddr.wallet_name }}
                </p>
              </div>
              }

              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Wallet
                    Address</label>
                  <p class="text-sm md:text-base font-mono text-white break-all leading-relaxed">
                    {{ walletAddr.wallet_address }}
                  </p>
                </div>
                <button type="button" (click)="copyToClipboard(walletAddr.wallet_address, 'Wallet address')"
                  class="shrink-0 w-10 h-10 rounded-full bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                  <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
                </button>
              </div>

              @if (walletAddr.other_details) {
              <div class="pt-2 border-t border-slate-700/50">
                <label class="text-xs text-purple-400 font-semibold mb-2 block uppercase tracking-wide">Other
                  Details</label>
                <p class="text-sm text-slate-300 leading-relaxed">
                  {{ walletAddr.other_details }}
                </p>
              </div>
              }
            </div>
          </div>
          }

          <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-3">
            <div class="flex items-start gap-2">
              <i class="pi pi-info-circle text-blue-400 text-sm mt-0.5 shrink-0"></i>
              <p class="text-xs text-slate-300 leading-relaxed">
                <strong class="text-blue-300">Important:</strong> Send exactly <strong class="text-white">{{
                  p2pOrder.quantity | number:'1.2-6' }} {{ p2pOrder.p2p_ad?.token_symbol }}</strong> to one of the
                wallet addresses above. Upload your proof of transfer after sending.
              </p>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- Proof of Payment Attachments -->
      @if (p2pOrder.status === 'pending' || p2pOrder.status === 'paid' || proofAttachments.length > 0) {
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-blue-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="pi pi-images text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-white mb-1">Proof of Payment</h3>
            <p class="text-xs text-slate-300 leading-relaxed">
              @if (proofAttachments.length > 0) {
              {{ isMerchant ? 'User\'s uploaded' : 'Your uploaded' }} proof of payment ({{ proofAttachments.length }}
              file{{ proofAttachments.length > 1 ? 's' : '' }})
              } @else {
              {{ isMerchant ? 'Waiting for user to upload' : 'Upload your' }} proof of payment
              }
            </p>
          </div>
        </div>

        @if (proofAttachments.length > 0) {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          @for (attachment of proofAttachments; track $index) {
          <div class="relative group">
            <!-- Image Attachment -->
            @if (attachment.type === 'image') {
            <div class="aspect-square rounded-3xl overflow-hidden border border-purple-500/20 bg-slate-900/50">
              <img [src]="attachment.url" [alt]="'Proof of payment ' + ($index + 1)"
                class="w-full h-full object-cover hover:scale-110 transition-transform duration-300 cursor-pointer"
                (click)="openImagePreview(attachment.url)" />
            </div>
            <div
              class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-200 rounded-3xl flex items-center justify-center">
              <button type="button" (click)="openImagePreview(attachment.url)"
                class="opacity-0 group-hover:opacity-100 px-4 py-2 rounded-3xl bg-white/90 hover:bg-white text-slate-900 font-semibold text-sm transition-all duration-200 cursor-pointer">
                <i class="pi pi-search-plus mr-2"></i>
                View Full
              </button>
            </div>
            }

            <!-- PDF Attachment -->
            @if (attachment.type === 'pdf') {
            <div
              class="aspect-square rounded-3xl border border-purple-500/20 bg-slate-900/50 flex flex-col items-center justify-center p-4 group hover:bg-slate-800/50 transition-all duration-200">
              <i class="pi pi-file-pdf text-6xl text-red-400 mb-3"></i>
              <p class="text-white font-semibold text-sm text-center mb-2">PDF Document</p>
              <p class="text-slate-400 text-xs text-center truncate w-full px-2">{{ attachment.filename }}</p>
              <div class="flex gap-2 mt-4">
                <a [href]="attachment.url" target="_blank"
                  class="px-3 py-1.5 rounded-3xl bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold transition-all duration-200 cursor-pointer">
                  <i class="pi pi-external-link mr-1"></i>
                  Open
                </a>
                <a [href]="attachment.url" download
                  class="px-3 py-1.5 rounded-3xl bg-purple-500 hover:bg-purple-600 text-white text-xs font-semibold transition-all duration-200 cursor-pointer">
                  <i class="pi pi-download mr-1"></i>
                  Download
                </a>
              </div>
            </div>
            }
          </div>
          }
        </div>
        } @else {
        <!-- Empty State -->
        <div class="bg-slate-900/50 rounded-3xl border border-slate-700/50 p-8">
          <div class="flex flex-col items-center justify-center text-center">
            <i class="pi pi-cloud-upload text-5xl text-slate-600 mb-3"></i>
            <p class="text-slate-400 font-semibold mb-1">No proof of payment uploaded yet</p>
            <p class="text-xs text-slate-500">
              {{ isMerchant ? 'The user will upload proof after sending payment' : 'Upload your proof after sending
              payment' }}
            </p>
          </div>
        </div>
        }
      </div>
      }

      <!-- MERCHANT + BUY ORDER: Your Receiving Payment Details -->
      @if (isMerchant && p2pOrder.order_type === 'buy' && selectedAdPaymentType) {
      <div class="backdrop-blur-xl bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
            <i class="pi pi-credit-card text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-green-300">Your Receiving Payment Details</h3>
            <p class="text-xs text-slate-300 leading-relaxed">Your payment account details where user sends payment</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-green-500/20">
            <div class="space-y-3">
              @if (selectedAdPaymentType.p2p_payment_type?.name) {
              <div class="flex items-center gap-3 pb-3 border-b border-slate-700/50">
                @if (selectedAdPaymentType.p2p_payment_type?.logo_url) {
                <img [src]="selectedAdPaymentType.p2p_payment_type!.logo_url"
                  [alt]="selectedAdPaymentType.p2p_payment_type!.name" class="w-8 h-8 object-contain shrink-0" />
                }
                <div class="flex-1">
                  <label class="text-xs text-green-400 font-semibold block uppercase tracking-wide">Payment
                    Method</label>
                  <p class="text-sm md:text-base font-semibold text-white">
                    {{ selectedAdPaymentType.p2p_payment_type?.name }}
                  </p>
                </div>
              </div>
              }

              @if (selectedAdPaymentType.account_name) {
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                  <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Account
                    Name</label>
                  <p class="text-sm md:text-base font-semibold text-white">
                    {{ selectedAdPaymentType.account_name }}
                  </p>
                </div>
                <button type="button" (click)="copyToClipboard(selectedAdPaymentType.account_name, 'Account name')"
                  class="shrink-0 w-10 h-10 rounded-full bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                  <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
                </button>
              </div>
              }

              @if (selectedAdPaymentType.account_number) {
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                  <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Account Number
                    / Mobile</label>
                  <p class="text-sm md:text-base font-mono text-white tracking-wide">
                    {{ selectedAdPaymentType.account_number }}
                  </p>
                </div>
                <button type="button" (click)="copyToClipboard(selectedAdPaymentType.account_number, 'Account number')"
                  class="shrink-0 w-10 h-10 rounded-full bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                  <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
                </button>
              </div>
              }

              @if (selectedAdPaymentType.other_details) {
              <div>
                <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Other
                  Details</label>
                <p class="text-sm text-slate-300 leading-relaxed">
                  {{ selectedAdPaymentType.other_details }}
                </p>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
      }

      <!-- MERCHANT + SELL ORDER: Your Receiving Wallet Addresses -->
      @if (isMerchant && p2pOrder.order_type === 'sell' && adWalletAddresses.length > 0) {
      <div class="backdrop-blur-xl bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
            <i class="pi pi-wallet text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-green-300">Your Receiving Wallet Addresses</h3>
            <p class="text-xs text-slate-300 leading-relaxed">
              Your {{ p2pOrder.p2p_ad?.token_symbol }} wallet addresses to receive tokens
            </p>
          </div>
        </div>

        <div class="space-y-3">
          @for (walletAddr of adWalletAddresses; track walletAddr.id) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-green-500/20">
            <div class="space-y-3">
              @if (walletAddr.wallet_name) {
              <div class="pb-3 border-b border-slate-700/50">
                <label class="text-xs text-green-400 font-semibold block uppercase tracking-wide mb-1">Wallet
                  Name</label>
                <p class="text-sm md:text-base font-semibold text-white">
                  {{ walletAddr.wallet_name }}
                </p>
              </div>
              }

              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Wallet
                    Address</label>
                  <p class="text-sm md:text-base font-mono text-white break-all leading-relaxed">
                    {{ walletAddr.wallet_address }}
                  </p>
                </div>
                <button type="button" (click)="copyToClipboard(walletAddr.wallet_address, 'Wallet address')"
                  class="shrink-0 w-10 h-10 rounded-full bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                  <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
                </button>
              </div>

              @if (walletAddr.other_details) {
              <div class="pt-2 border-t border-slate-700/50">
                <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Other
                  Details</label>
                <p class="text-sm text-slate-300 leading-relaxed">
                  {{ walletAddr.other_details }}
                </p>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- USER + BUY ORDER: Your Receiving Wallet Address -->
      @if (isUser && p2pOrder.order_type === 'buy' && p2pOrder.wallet_address) {
      <div class="backdrop-blur-xl bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
            <i class="pi pi-wallet text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-green-300">Your Receiving Wallet Address</h3>
            <p class="text-xs text-slate-300 leading-relaxed">
              Your wallet address to receive {{ p2pOrder.p2p_ad?.token_symbol }} tokens
            </p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-green-500/20">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Wallet
                  Address</label>
                <p class="text-sm md:text-base font-mono text-white break-all leading-relaxed">
                  {{ p2pOrder.wallet_address }}
                </p>
              </div>
              <button type="button" (click)="copyToClipboard(p2pOrder.wallet_address, 'Wallet address')"
                class="shrink-0 w-10 h-10 rounded-full bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- USER + SELL ORDER: Your Receiving Payment Details -->
      @if (isUser && p2pOrder.order_type === 'sell' && (p2pOrder.account_name || p2pOrder.account_number)) {
      <div class="backdrop-blur-xl bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4 md:p-6">
        <div class="flex items-start gap-3 mb-4">
          <div
            class="w-10 h-10 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
            <i class="pi pi-credit-card text-white"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-bold text-green-300">Your Receiving Payment Details</h3>
            <p class="text-xs text-slate-300 leading-relaxed">Your account details to receive payment</p>
          </div>
        </div>

        <div class="space-y-3">
          @if (p2pOrder.account_name) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-green-500/20">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Account
                  Name</label>
                <p class="text-sm md:text-base font-semibold text-white">
                  {{ p2pOrder.account_name }}
                </p>
              </div>
              <button type="button" (click)="copyToClipboard(p2pOrder.account_name, 'Account name')"
                class="shrink-0 w-10 h-10 rounded-full bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
              </button>
            </div>
          </div>
          }

          @if (p2pOrder.account_number) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-green-500/20">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <label class="text-xs text-green-400 font-semibold mb-2 block uppercase tracking-wide">Account Number /
                  Mobile Number</label>
                <p class="text-sm md:text-base font-mono text-white tracking-wide">
                  {{ p2pOrder.account_number }}
                </p>
              </div>
              <button type="button" (click)="copyToClipboard(p2pOrder.account_number, 'Account number')"
                class="shrink-0 w-10 h-10 rounded-full bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-300 transition-all duration-200 flex items-center justify-center cursor-pointer group">
                <i class="pi pi-copy group-hover:scale-110 transition-transform"></i>
              </button>
            </div>
          </div>
          }

          @if (p2pOrder.p2p_payment_type?.name) {
          <div class="bg-slate-900/50 rounded-3xl p-4 border border-green-500/20">
            <div class="flex items-center gap-3">
              @if (p2pOrder.p2p_payment_type?.logo_url) {
              <img [src]="p2pOrder.p2p_payment_type!.logo_url" [alt]="p2pOrder.p2p_payment_type!.name"
                class="w-8 h-8 object-contain shrink-0" />
              }
              <div class="flex-1">
                <label class="text-xs text-green-400 font-semibold mb-1 block uppercase tracking-wide">Payment
                  Method</label>
                <p class="text-sm md:text-base font-semibold text-white">
                  {{ p2pOrder.p2p_payment_type?.name }}
                </p>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- Action Buttons -->
      @if (p2pOrder.status === 'pending' || p2pOrder.status === 'paid') {
      <div class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 p-4 md:p-6">
        <div class="flex flex-wrap gap-3">

          <!-- PENDING: User Upload Proof Button -->
          @if (showUploadProofButton) {
          <button type="button" (click)="openPaymentProofDialog()"
            class="flex-1 min-w-50 px-4 py-2.5 rounded-3xl bg-linear-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2 shadow-md cursor-pointer">
            <i class="pi pi-upload"></i>
            <span>Pay & Upload Proof</span>
          </button>
          }

          <!-- PAID: Merchant Notify Token Sent Button -->
          @if (showNotifyTokenSentButton) {
          <button type="button" (click)="openNotifyTokenDialog()"
            class="flex-1 min-w-50 px-4 py-2.5 rounded-3xl bg-linear-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2 shadow-md cursor-pointer">
            <i class="pi pi-send"></i>
            <span>Notify {{ p2pOrder.p2p_ad?.token_symbol }} Sent</span>
          </button>
          }

          <!-- PAID: User Confirm Token Received Button -->
          @if (showConfirmTokenReceivedButton) {
          <button type="button" (click)="openConfirmReceivedDialog()"
            class="flex-1 min-w-50 px-4 py-2.5 rounded-3xl bg-linear-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2 shadow-md cursor-pointer">
            <i class="pi pi-check-circle"></i>
            <span>Confirm {{ p2pOrder.p2p_ad?.token_symbol }} Received</span>
          </button>
          }

          <!-- Cancel Button (conditional based on status) -->
          @if (showCancelButton) {
          <button type="button" (click)="openCancelOrderDialog()"
            class="px-4 py-2.5 rounded-3xl bg-red-500/20 hover:bg-red-500/30 text-red-300 border border-red-500/30 font-medium text-sm transition-all duration-200 flex items-center gap-2 cursor-pointer">
            <i class="pi pi-times-circle"></i>
            <span>Cancel Order</span>
          </button>
          }
        </div>
      </div>
      }
    </div>

    <!-- Right Column: Chat (1/3 width on desktop, full width on mobile) -->
    <div class="lg:col-span-1">
      <div
        class="backdrop-blur-xl bg-slate-800/50 rounded-3xl border border-purple-500/20 overflow-hidden sticky top-4">

        <!-- Chat Header with Merchant Info -->
        <div class="p-4 border-b border-slate-700/50 bg-slate-900/50">
          <div class="flex items-center gap-3">
            @if (p2pOrder.p2p_ad?.logo_url) {
            <img [src]="p2pOrder.p2p_ad?.logo_url" [alt]="p2pOrder.p2p_ad?.name"
              class="w-10 h-10 rounded-full object-cover shrink-0" />
            } @else {
            <div
              class="w-10 h-10 rounded-full bg-linear-to-r from-purple-500 to-pink-500 flex items-center justify-center shrink-0">
              <i class="pi pi-user text-white"></i>
            </div>
            }
            <div class="flex-1 min-w-0">
              <h3 class="text-base font-bold text-white truncate">{{ p2pOrder.p2p_ad?.name }}</h3>
              <div class="flex items-center gap-2">
                <img [src]="'/images/tokens/' + (p2pOrder.p2p_ad?.token_symbol || 'usdt').toLowerCase() + '.png'"
                  [alt]="p2pOrder.p2p_ad?.token_symbol || 'USDT'" class="w-3.5 h-3.5 object-contain" />
                <span class="text-xs text-slate-400">{{ p2pOrder.p2p_ad?.token_symbol }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages p-4 space-y-3 bg-slate-900/30" style="height: 400px; max-height: 400px;">
          @for (msg of chatMessages; track msg.timestamp) {
          @if (msg.sender === 'me') {

          <!-- My Message -->
          <div class="flex justify-end">
            <div class="max-w-[80%]">
              <div class="bg-linear-to-r from-purple-600 to-pink-600 rounded-3xl rounded-tr-sm p-3">
                <p class="text-sm text-white">{{ msg.message }}</p>
              </div>
              <p class="text-xs text-slate-500 mt-1 text-right">{{ formatMessageTime(msg.timestamp) }}</p>
            </div>
          </div>
          } @else {

          <!-- Other's Message -->
          <div class="flex justify-start">
            <div class="max-w-[80%]">
              <div class="flex items-center gap-2 mb-1">
                <div
                  class="w-6 h-6 rounded-full bg-linear-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                  <i class="pi pi-user text-white text-xs"></i>
                </div>
                <span class="text-xs font-medium text-slate-400">{{ msg.senderName }}</span>
              </div>
              <div class="bg-slate-700/50 rounded-3xl rounded-tl-sm p-3">
                <p class="text-sm text-slate-200">{{ msg.message }}</p>
              </div>
              <p class="text-xs text-slate-500 mt-1">{{ formatMessageTime(msg.timestamp) }}</p>
            </div>
          </div>
          }
          }

          @if (chatMessages.length === 0) {
          <div class="flex flex-col items-center justify-center h-full text-center">
            <i class="pi pi-comments text-4xl text-slate-600 mb-2"></i>
            <p class="text-sm text-slate-500">No messages yet</p>
            <p class="text-xs text-slate-600 mt-1">Start a conversation</p>
          </div>
          }
        </div>

        <!-- Chat Input -->
        @if (p2pOrder.status !== 'completed' && p2pOrder.status !== 'cancelled') {
        <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
          <div class="flex gap-2">
            <input type="text" [(ngModel)]="chatMessage" (keyup.enter)="sendMessage()" placeholder="Type a message..."
              class="flex-1 px-4 py-2.5 rounded-3xl bg-slate-800/50 border border-slate-700/50 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500/50 text-sm" />
            <button (click)="sendMessage()" [disabled]="!chatMessage || !chatMessage.trim()"
              [class.opacity-50]="!chatMessage || !chatMessage.trim()"
              [class.cursor-not-allowed]="!chatMessage || !chatMessage.trim()"
              class="px-4 py-2.5 rounded-3xl bg-linear-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white transition-all duration-200 cursor-pointer">
              <i class="pi pi-send"></i>
            </button>
          </div>
        </div>
        }
        @if (p2pOrder.status === 'completed' || p2pOrder.status === 'cancelled') {
        <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
          <div class="text-center py-2">
            <p class="text-xs text-slate-500">Chat is disabled for {{ p2pOrder.status }} orders</p>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
  }
</div>

<!-- Payment Proof Upload Dialog -->
<p-dialog [(visible)]="showPaymentProofDialog" [modal]="true" [closable]="true" [draggable]="false"
  [style]="{ width: '95vw', maxWidth: '500px', 'border-radius': '1.5rem' }">
  <ng-template #header>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-linear-to-r from-yellow-500 to-orange-500 flex items-center justify-center">
        <i class="pi pi-upload text-white text-lg"></i>
      </div>
      <span class="text-lg font-bold text-white">Upload Proof of Payment</span>
    </div>
  </ng-template>

  <div class="space-y-5 py-4">
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="space-y-3 text-sm">
        @if (p2pOrder?.order_type === 'buy') {
        <div class="flex justify-between items-center">
          <span class="text-slate-400">You Will Send</span>
          <span class="text-white font-bold text-lg">₱{{ p2pOrder?.amount | number:'1.2-2' }} PHP</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-slate-400">You Will Receive</span>
          <span class="text-white font-semibold">{{ p2pOrder?.quantity | number:'1.2-6' }} Token</span>
        </div>
        } @else {
        <div class="flex justify-between items-center">
          <span class="text-slate-400">You Will Send</span>
          <span class="text-white font-bold text-lg">{{ p2pOrder?.quantity | number:'1.2-6' }} Token</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-slate-400">You Will Receive</span>
          <span class="text-white font-semibold">₱{{ p2pOrder?.amount | number:'1.2-2' }} PHP</span>
        </div>
        }
      </div>
    </div>

    <div class="space-y-2">
      <label class="text-sm font-semibold text-white">Payment Proof (Screenshot/Receipt) - Up to 3 files</label>
      <div class="relative">
        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*,.pdf" class="hidden" multiple />

        @if (selectedFiles.length < maxFiles) { <div (click)="fileInput.click()"
          class="border-2 border-dashed border-slate-600 rounded-3xl p-8 text-center cursor-pointer hover:border-purple-500/50 hover:bg-purple-500/5 transition-all duration-200">
          <div class="space-y-3">
            <i class="pi pi-cloud-upload text-4xl text-slate-500"></i>
            <div class="space-y-1">
              <p class="text-white font-semibold">Click to upload ({{ selectedFiles.length }}/{{ maxFiles }})</p>
              <p class="text-xs text-slate-400">PNG, JPG, PDF up to 10MB each</p>
            </div>
          </div>
      </div>
      }

      @if (selectedFiles.length > 0) {
      <div class="space-y-2 mt-3">
        @for (file of selectedFiles; track $index) {
        <div class="flex items-center gap-3 bg-slate-800/30 border border-slate-700/50 rounded-2xl p-3">
          <i class="pi pi-file text-2xl text-green-400"></i>
          <div class="flex-1 min-w-0">
            <p class="text-white font-semibold text-sm truncate">{{ file.name }}</p>
            <p class="text-xs text-slate-400">{{ (file.size / 1024).toFixed(2) }} KB</p>
          </div>
          <button type="button" (click)="removeFile($index)"
            class="w-8 h-8 rounded-full bg-red-500/20 hover:bg-red-500/30 text-red-300 flex items-center justify-center transition-all duration-200 cursor-pointer">
            <i class="pi pi-times text-sm"></i>
          </button>
        </div>
        }
      </div>
      }
    </div>
  </div>
  </div>

  <ng-template #footer>
    <div class="flex gap-3 pt-2">
      <button type="button" (click)="uploadPaymentProof()" [disabled]="selectedFiles.length === 0"
        [class.opacity-50]="selectedFiles.length === 0" [class.cursor-not-allowed]="selectedFiles.length === 0"
        class="px-6 py-3.5 rounded-3xl bg-linear-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg cursor-pointer">
        <i class="pi pi-check"></i>
        <span>Submit Proof ({{ selectedFiles.length }})</span>
      </button>
      <button type="button" (click)="closePaymentProofDialog()"
        class="px-6 py-3 rounded-3xl bg-slate-700/50 hover:bg-slate-600/50 text-white font-semibold transition-all duration-200 cursor-pointer">
        Cancel
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Mobile Order Details Dialog -->
<p-dialog [(visible)]="showMobileOrderDetailsDialog" [modal]="true" [closable]="true" [draggable]="false"
  [style]="{ width: '95vw', maxWidth: '500px', 'border-radius': '1.5rem' }">
  <ng-template #header>
    <div class="flex items-center gap-3">
      <div
        [class]="p2pOrder && p2pOrder.order_type === 'buy' ? 'bg-linear-to-r from-green-500 to-green-600' : 'bg-linear-to-r from-purple-600 to-pink-600'"
        class="w-10 h-10 rounded-full flex items-center justify-center">
        <i class="pi pi-shopping-cart text-white text-lg"></i>
      </div>
      <span class="text-lg font-bold text-white">Order Details</span>
    </div>
  </ng-template>

  @if (p2pOrder) {
  <div class="space-y-4 py-4 max-h-[70vh] overflow-y-auto">
    <!-- Status Info -->
    <div [class]="'border-2 rounded-3xl p-4 bg-' + statusColorClass + '-500/10 border-' + statusColorClass + '-500/30'">
      <div class="flex items-start gap-3">
        <div
          [class]="'w-10 h-10 rounded-full flex items-center justify-center shrink-0 bg-linear-to-r from-' + statusColorClass + '-500 to-' + statusColorClass + '-600'">
          <i [class]="'pi text-white ' + statusIcon"></i>
        </div>
        <div class="flex-1 space-y-1">
          <h3 class="text-base font-bold text-white">{{ statusTitle }}</h3>
          <p class="text-sm text-slate-300" [innerHTML]="statusMessage"></p>
        </div>
      </div>
    </div>

    <!-- Order Details -->
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
          <i class="pi pi-file-edit text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-white">Order Details</h3>
      </div>

      <!-- Order info -->
      <div class="space-y-3 text-sm">
        <div class="flex justify-between">
          <span class="text-slate-400">Order Number</span>
          <span class="text-white font-semibold font-mono">{{ p2pOrder.id }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-slate-400">Merchant</span>
          <div class="text-right">
            <p class="text-white font-semibold">{{ p2pOrder.p2p_ad?.name || 'Anonymous' }}</p>
            @if (p2pOrder.p2p_ad?.logo_url && p2pOrder.p2p_ad?.token_symbol) {
            <div class="flex items-center gap-1 justify-end mt-0.5">
              <img [src]="p2pOrder.p2p_ad!.logo_url" [alt]="p2pOrder.p2p_ad!.token_symbol"
                class="w-4 h-4 object-contain" />
              <span class="text-xs text-slate-400">{{ p2pOrder.p2p_ad?.token_symbol }}</span>
            </div>
            }
          </div>
        </div>
        <div class="flex justify-between">
          <span class="text-slate-400">Price</span>
          <span class="text-white font-semibold">₱{{ p2pOrder.ordered_price | number:'1.2-2' }} PHP</span>
        </div>
        <div class="flex justify-between">
          <span class="text-slate-400">Quantity</span>
          <span class="text-white font-semibold">
            {{ p2pOrder.quantity | number:'1.2-6' }} {{ p2pOrder.p2p_ad?.token_symbol }}
          </span>
        </div>
        <div class="flex justify-between pt-2 border-t border-slate-700/50">
          <span class="text-slate-400 font-semibold">Total Amount</span>
          <span class="text-white font-bold text-base">₱{{ p2pOrder.amount | number:'1.2-2' }} PHP</span>
        </div>
        @if (p2pOrder.p2p_payment_type) {
        <div class="flex justify-between">
          <span class="text-slate-400">Payment Method</span>
          <span class="text-white font-semibold">{{ p2pOrder.p2p_payment_type.name }}</span>
        </div>
        }
      </div>
    </div>

    <!-- Merchant BUY: User's USDT Delivery Address (slate theme) -->
    @if (p2pOrder.order_type === 'buy' && paramsViewType === 'ad-orders' && p2pOrder.wallet_address) {
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
          <i class="pi pi-wallet text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-white">
          User's {{ p2pOrder.p2p_ad?.token_symbol || 'Token' }} Delivery Address
        </h3>
      </div>

      <div class="bg-slate-900/50 rounded-2xl p-3 border border-purple-500/20">
        <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Wallet Address</label>
        <div class="flex items-start gap-2">
          <p class="flex-1 text-xs font-mono text-white break-all leading-relaxed">{{ p2pOrder.wallet_address }}</p>
          <button type="button" (click)="copyToClipboard(p2pOrder.wallet_address, 'Wallet address')"
            class="shrink-0 w-9 h-9 rounded-full bg-purple-500/20 border border-purple-500/30 text-purple-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
            <i class="pi pi-copy text-sm"></i>
          </button>
        </div>
      </div>

      <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-2.5 mt-3">
        <div class="flex items-start gap-2">
          <i class="pi pi-info-circle text-blue-400 text-xs mt-0.5 shrink-0"></i>
          <p class="text-xs text-slate-300 leading-relaxed">
            Send exactly <strong class="text-white">{{ p2pOrder.quantity | number:'1.2-6' }} {{
              p2pOrder.p2p_ad?.token_symbol }}</strong> to this address.
          </p>
        </div>
      </div>
    </div>
    }

    <!-- Merchant SELL: User's payment details (slate theme) -->
    @if (p2pOrder.order_type === 'sell' && paramsViewType === 'ad-orders' && (p2pOrder.account_name ||
    p2pOrder.account_number)) {
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
          <i class="pi pi-wallet text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-white">User's Payment Details</h3>
      </div>

      <div class="space-y-2.5">
        @if (p2pOrder.account_name) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-purple-500/20">
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Name</label>
              <p class="text-sm font-semibold text-white">{{ p2pOrder.account_name }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(p2pOrder.account_name, 'Account name')"
              class="shrink-0 w-9 h-9 rounded-full bg-purple-500/20 border border-purple-500/30 text-purple-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
        </div>
        }

        @if (p2pOrder.account_number) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-purple-500/20">
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Number</label>
              <p class="text-sm font-mono text-white">{{ p2pOrder.account_number }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(p2pOrder.account_number, 'Account number')"
              class="shrink-0 w-9 h-9 rounded-full bg-purple-500/20 border border-purple-500/30 text-purple-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
        </div>
        }

        @if (p2pOrder.p2p_payment_type) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-purple-500/20">
          <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Payment
            Method</label>
          <div class="flex items-center gap-2">
            @if (p2pOrder.p2p_payment_type.logo_url) {
            <img [src]="p2pOrder.p2p_payment_type!.logo_url" [alt]="p2pOrder.p2p_payment_type!.name"
              class="w-6 h-6 object-contain shrink-0" />
            }
            <p class="text-sm font-semibold text-white">{{ p2pOrder.p2p_payment_type.name }}</p>
          </div>
        </div>
        }

        <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-2.5">
          <div class="flex items-start gap-2">
            <i class="pi pi-info-circle text-blue-400 text-xs mt-0.5 shrink-0"></i>
            <p class="text-xs text-slate-300 leading-relaxed">
              Send exactly <strong class="text-white">₱{{ p2pOrder.amount | number:'1.2-2' }}</strong> to the account
              above.
            </p>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- User BUY: Merchant's payment details (slate theme, single payment only) -->
    @if (p2pOrder.order_type === 'buy' && paramsViewType === 'my-orders' && adPaymentTypes.length > 0) {
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
          <i class="pi pi-file-edit text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-white">Merchant Payment Details</h3>
      </div>

      @for (paymentType of adPaymentTypes; track paymentType.id) {
      @if (paymentType.p2p_payment_type_id === p2pOrder.p2p_payment_type_id) {
      <div class="bg-slate-900/50 rounded-2xl p-3 border border-purple-500/20">
        <div class="space-y-2.5">
          @if (paymentType.p2p_payment_type?.name) {
          <div class="flex items-center gap-2 pb-2.5 border-b border-slate-700/50">
            @if (paymentType.p2p_payment_type?.logo_url) {
            <img [src]="paymentType.p2p_payment_type!.logo_url" [alt]="paymentType.p2p_payment_type!.name"
              class="w-6 h-6 object-contain shrink-0" />
            }
            <div class="flex-1">
              <label class="text-xs text-purple-400 font-semibold block uppercase tracking-wide">Payment Method</label>
              <p class="text-sm font-semibold text-white">{{ paymentType.p2p_payment_type?.name }}</p>
            </div>
          </div>
          }

          @if (paymentType.account_name) {
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Name</label>
              <p class="text-sm font-semibold text-white">{{ paymentType.account_name }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(paymentType.account_name, 'Account name')"
              class="shrink-0 w-9 h-9 rounded-full bg-purple-500/20 border border-purple-500/30 text-purple-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
          }

          @if (paymentType.account_number) {
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Number</label>
              <p class="text-sm font-mono text-white">{{ paymentType.account_number }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(paymentType.account_number, 'Account number')"
              class="shrink-0 w-9 h-9 rounded-full bg-purple-500/20 border border-purple-500/30 text-purple-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
          }

          @if (paymentType.other_details) {
          <div>
            <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Other
              Details</label>
            <p class="text-xs text-slate-300 leading-relaxed">{{ paymentType.other_details }}</p>
          </div>
          }
        </div>
      </div>

      <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-2.5 mt-3">
        <div class="flex items-start gap-2">
          <i class="pi pi-info-circle text-blue-400 text-xs mt-0.5 shrink-0"></i>
          <p class="text-xs text-slate-300 leading-relaxed">
            Send exactly <strong class="text-white">₱{{ p2pOrder.amount | number:'1.2-2' }}</strong> to the payment
            account above.
          </p>
        </div>
      </div>
      }
      }
    </div>
    }

    <!-- User SELL: Merchant's wallet addresses (slate theme, list) -->
    @if (p2pOrder.order_type === 'sell' && paramsViewType === 'my-orders' && adWalletAddresses.length > 0) {
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-purple-500 to-purple-600 flex items-center justify-center shrink-0">
          <i class="pi pi-file-edit text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-white">
          Merchant {{ p2pOrder.p2p_ad?.token_symbol || 'Token' }} Wallets
        </h3>
      </div>

      <div class="space-y-2.5">
        @for (walletAddr of adWalletAddresses; track walletAddr.id) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-purple-500/20">
          <div class="space-y-2.5">
            @if (walletAddr.wallet_name) {
            <div class="pb-2.5 border-b border-slate-700/50">
              <label class="text-xs text-purple-400 font-semibold block uppercase tracking-wide mb-1">Wallet
                Name</label>
              <p class="text-sm font-semibold text-white">{{ walletAddr.wallet_name }}</p>
            </div>
            }

            <div class="flex items-start gap-2">
              <div class="flex-1 min-w-0">
                <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Wallet
                  Address</label>
                <p class="text-xs font-mono text-white break-all leading-relaxed">{{ walletAddr.wallet_address }}</p>
              </div>
              <button type="button" (click)="copyToClipboard(walletAddr.wallet_address, 'Wallet address')"
                class="shrink-0 w-9 h-9 rounded-full bg-purple-500/20 border border-purple-500/30 text-purple-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
                <i class="pi pi-copy text-sm"></i>
              </button>
            </div>

            @if (walletAddr.other_details) {
            <div class="pt-2 border-t border-slate-700/50">
              <label class="text-xs text-purple-400 font-semibold mb-1.5 block uppercase tracking-wide">Other
                Details</label>
              <p class="text-xs text-slate-300 leading-relaxed">{{ walletAddr.other_details }}</p>
            </div>
            }
          </div>
        </div>
        }

        <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-2.5">
          <div class="flex items-start gap-2">
            <i class="pi pi-info-circle text-blue-400 text-xs mt-0.5 shrink-0"></i>
            <p class="text-xs text-slate-300 leading-relaxed">
              Send exactly <strong class="text-white">{{ p2pOrder.quantity | number:'1.2-6' }} {{
                p2pOrder.p2p_ad?.token_symbol }}</strong> to one of the wallet addresses above.
            </p>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Proof of Payment Attachments (Mobile) -->
    @if (p2pOrder.status === 'pending' || p2pOrder.status === 'paid' || proofAttachments.length > 0) {
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-blue-500 to-blue-600 flex items-center justify-center shrink-0">
          <i class="pi pi-images text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-white">Proof of Payment</h3>
      </div>

      @if (proofAttachments.length > 0) {
      <div class="grid grid-cols-2 gap-2">
        @for (attachment of proofAttachments; track $index) {
        <!-- Image Attachment -->
        @if (attachment.type === 'image') {
        <div class="relative group">
          <div class="aspect-square rounded-2xl overflow-hidden border border-purple-500/20 bg-slate-900/50">
            <img [src]="attachment.url" [alt]="'Proof ' + ($index + 1)"
              class="w-full h-full object-cover cursor-pointer active:scale-95 transition-transform"
              (click)="openImagePreview(attachment.url)" />
          </div>
        </div>
        }

        <!-- PDF Attachment -->
        @if (attachment.type === 'pdf') {
        <div
          class="aspect-square rounded-2xl border border-purple-500/20 bg-slate-900/50 flex flex-col items-center justify-center p-2">
          <i class="pi pi-file-pdf text-3xl text-red-400 mb-1"></i>
          <p class="text-white font-semibold text-xs text-center mb-1">PDF</p>
          <div class="flex gap-1">
            <a [href]="attachment.url" target="_blank"
              class="px-2 py-1 rounded-2xl bg-blue-500 text-white text-xs font-semibold cursor-pointer">
              <i class="pi pi-external-link"></i>
            </a>
            <a [href]="attachment.url" download
              class="px-2 py-1 rounded-2xl bg-purple-500 text-white text-xs font-semibold cursor-pointer">
              <i class="pi pi-download"></i>
            </a>
          </div>
        </div>
        }
        }
      </div>
      } @else {
      <!-- Empty State -->
      <div class="bg-slate-900/50 rounded-2xl border border-slate-700/50 p-6">
        <div class="flex flex-col items-center justify-center text-center">
          <i class="pi pi-cloud-upload text-4xl text-slate-600 mb-2"></i>
          <p class="text-slate-400 font-semibold text-xs mb-1">No proof uploaded yet</p>
          <p class="text-xs text-slate-500">
            {{ isMerchant ? 'User will upload after payment' : 'Upload after sending payment' }}
          </p>
        </div>
      </div>
      }
    </div>
    }

    <!-- Merchant BUY: Your receiving payment details (green theme, single payment only) -->
    @if (p2pOrder.order_type === 'buy' && paramsViewType === 'ad-orders' && adPaymentTypes.length > 0) {
    <div class="bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
          <i class="pi pi-credit-card text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-green-300">Your Receiving Payment Details</h3>
      </div>

      @for (paymentType of adPaymentTypes; track paymentType.id; let i = $index) {
      @if (paymentType.p2p_payment_type_id === p2pOrder.p2p_payment_type_id) {
      <div class="bg-slate-900/50 rounded-2xl p-3 border border-green-500/20">
        <div class="space-y-2.5">
          @if (paymentType.p2p_payment_type?.name) {
          <div class="flex items-center gap-2 pb-2.5 border-b border-slate-700/50">
            @if (paymentType.p2p_payment_type?.logo_url) {
            <img [src]="paymentType.p2p_payment_type!.logo_url" [alt]="paymentType.p2p_payment_type!.name"
              class="w-6 h-6 object-contain shrink-0" />
            }
            <div class="flex-1">
              <label class="text-xs text-green-400 font-semibold block uppercase tracking-wide">Payment Method</label>
              <p class="text-sm font-semibold text-white">{{ paymentType.p2p_payment_type?.name }}</p>
            </div>
          </div>
          }

          @if (paymentType.account_name) {
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Name</label>
              <p class="text-sm font-semibold text-white">{{ paymentType.account_name }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(paymentType.account_name, 'Account name')"
              class="shrink-0 w-9 h-9 rounded-full bg-green-500/20 border border-green-500/30 text-green-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
          }

          @if (paymentType.account_number) {
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Number</label>
              <p class="text-sm font-mono text-white">{{ paymentType.account_number }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(paymentType.account_number, 'Account number')"
              class="shrink-0 w-9 h-9 rounded-full bg-green-500/20 border border-green-500/30 text-green-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
          }

          @if (paymentType.other_details) {
          <div>
            <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Other
              Details</label>
            <p class="text-xs text-slate-300 leading-relaxed">{{ paymentType.other_details }}</p>
          </div>
          }
        </div>
      </div>
      }
      }
    </div>
    }

    <!-- Merchant SELL: Your receiving wallet addresses (green theme, list) -->
    @if (p2pOrder.order_type === 'sell' && paramsViewType === 'ad-orders' && adWalletAddresses.length > 0) {
    <div class="bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
          <i class="pi pi-wallet text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-green-300">
          Your Receiving {{ p2pOrder.p2p_ad?.token_symbol || 'Token' }} Wallets
        </h3>
      </div>

      <div class="space-y-2.5">
        @for (walletAddr of adWalletAddresses; track walletAddr.id) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-green-500/20">
          <div class="space-y-2.5">
            @if (walletAddr.wallet_name) {
            <div class="pb-2.5 border-b border-slate-700/50">
              <label class="text-xs text-green-400 font-semibold block uppercase tracking-wide mb-1">Wallet Name</label>
              <p class="text-sm font-semibold text-white">{{ walletAddr.wallet_name }}</p>
            </div>
            }

            <div class="flex items-start gap-2">
              <div class="flex-1 min-w-0">
                <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Wallet
                  Address</label>
                <p class="text-xs font-mono text-white break-all leading-relaxed">{{ walletAddr.wallet_address }}</p>
              </div>
              <button type="button" (click)="copyToClipboard(walletAddr.wallet_address, 'Wallet address')"
                class="shrink-0 w-9 h-9 rounded-full bg-green-500/20 border border-green-500/30 text-green-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
                <i class="pi pi-copy text-sm"></i>
              </button>
            </div>

            @if (walletAddr.other_details) {
            <div class="pt-2 border-t border-slate-700/50">
              <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Other
                Details</label>
              <p class="text-xs text-slate-300 leading-relaxed">{{ walletAddr.other_details }}</p>
            </div>
            }
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- User BUY: Your receiving wallet address (green theme) -->
    @if (p2pOrder.order_type === 'buy' && paramsViewType === 'my-orders' && p2pOrder.wallet_address) {
    <div class="bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
          <i class="pi pi-wallet text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-green-300">Your Receiving Wallet Address</h3>
      </div>

      <div class="bg-slate-900/50 rounded-2xl p-3 border border-green-500/20">
        <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Wallet Address</label>
        <div class="flex items-start gap-2">
          <p class="flex-1 text-xs font-mono text-white break-all leading-relaxed">{{ p2pOrder.wallet_address }}</p>
          <button type="button" (click)="copyToClipboard(p2pOrder.wallet_address, 'Wallet address')"
            class="shrink-0 w-9 h-9 rounded-full bg-green-500/20 border border-green-500/30 text-green-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
            <i class="pi pi-copy text-sm"></i>
          </button>
        </div>
      </div>
    </div>
    }

    <!-- User SELL: Your receiving payment details (green theme) -->
    @if (p2pOrder.order_type === 'sell' && paramsViewType === 'my-orders' && (p2pOrder.account_name ||
    p2pOrder.account_number)) {
    <div class="bg-green-500/10 border-2 border-green-500/30 rounded-3xl p-4">
      <div class="flex items-center gap-2 mb-3">
        <div
          class="w-8 h-8 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center shrink-0">
          <i class="pi pi-credit-card text-white text-sm"></i>
        </div>
        <h3 class="text-sm font-bold text-green-300">Your Receiving Payment Details</h3>
      </div>

      <div class="space-y-2.5">
        @if (p2pOrder.account_name) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-green-500/20">
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Name</label>
              <p class="text-sm font-semibold text-white">{{ p2pOrder.account_name }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(p2pOrder.account_name, 'Account name')"
              class="shrink-0 w-9 h-9 rounded-full bg-green-500/20 border border-green-500/30 text-green-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
        </div>
        }

        @if (p2pOrder.account_number) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-green-500/20">
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Account
                Number</label>
              <p class="text-sm font-mono text-white">{{ p2pOrder.account_number }}</p>
            </div>
            <button type="button" (click)="copyToClipboard(p2pOrder.account_number, 'Account number')"
              class="shrink-0 w-9 h-9 rounded-full bg-green-500/20 border border-green-500/30 text-green-300 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
              <i class="pi pi-copy text-sm"></i>
            </button>
          </div>
        </div>
        }

        @if (p2pOrder.p2p_payment_type) {
        <div class="bg-slate-900/50 rounded-2xl p-3 border border-green-500/20">
          <label class="text-xs text-green-400 font-semibold mb-1.5 block uppercase tracking-wide">Payment
            Method</label>
          <div class="flex items-center gap-2">
            @if (p2pOrder.p2p_payment_type.logo_url) {
            <img [src]="p2pOrder.p2p_payment_type!.logo_url" [alt]="p2pOrder.p2p_payment_type!.name"
              class="w-6 h-6 object-contain shrink-0" />
            }
            <p class="text-sm font-semibold text-white">{{ p2pOrder.p2p_payment_type.name }}</p>
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- Action Buttons -->
    <div class="space-y-2">

      <!-- PENDING: User Upload Proof Button -->
      @if (showUploadProofButton) {
      <button type="button" (click)="openPaymentProofDialog(); showMobileOrderDetailsDialog = false"
        class="w-full px-4 py-3 rounded-3xl bg-linear-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
        <i class="pi pi-upload"></i>
        <span>Pay & Upload Proof</span>
      </button>
      }

      <!-- PAID: Merchant Notify Token Sent Button -->
      @if (showNotifyTokenSentButton) {
      <button type="button" (click)="openNotifyTokenDialog(); showMobileOrderDetailsDialog = false"
        class="w-full px-4 py-3 rounded-3xl bg-linear-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
        <i class="pi pi-send"></i>
        <span>Notify {{ p2pOrder.p2p_ad?.token_symbol }} Sent</span>
      </button>
      }

      <!-- PAID: User Confirm Token Received Button -->
      @if (showConfirmTokenReceivedButton) {
      <button type="button" (click)="openConfirmReceivedDialog(); showMobileOrderDetailsDialog = false"
        class="w-full px-4 py-3 rounded-3xl bg-linear-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
        <i class="pi pi-check-circle"></i>
        <span>Confirm {{ p2pOrder.p2p_ad?.token_symbol }} Received</span>
      </button>
      }

      <!-- Cancel Button (conditional based on status) -->
      @if (showCancelButton) {
      <button type="button" (click)="openCancelOrderDialog(); showMobileOrderDetailsDialog = false"
        class="w-full px-4 py-2.5 rounded-3xl bg-red-500/20 hover:bg-red-500/30 text-red-300 border border-red-500/30 font-medium text-sm transition-all duration-200 cursor-pointer">
        <i class="pi pi-times-circle mr-1.5"></i>
        Cancel Order
      </button>
      }
    </div>
  </div>
  }
</p-dialog>

<!-- Confirm Token Received Dialog -->
<p-dialog [(visible)]="showConfirmReceivedDialog" [modal]="true" [closable]="true" [draggable]="false"
  [style]="{ width: '95vw', maxWidth: '450px', 'border-radius': '1.5rem' }">
  <ng-template #header>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-linear-to-r from-green-500 to-green-600 flex items-center justify-center">
        <i class="pi pi-check-circle text-white text-lg"></i>
      </div>
      <span class="text-lg font-bold text-white">Confirm Token Received</span>
    </div>
  </ng-template>
  <div class="space-y-4 py-4">
    <div class="bg-yellow-500/10 border-2 border-yellow-500/30 rounded-3xl p-4">
      <div class="flex items-start gap-3">
        <i class="pi pi-exclamation-triangle text-yellow-400 text-xl mt-0.5"></i>
        <div class="space-y-2">
          <p class="text-white font-semibold text-sm">Please verify before confirming:</p>
          <ul class="text-xs text-slate-300 space-y-1 list-disc list-inside">
            <li>You have received the Token in your wallet</li>
            <li>The amount matches the order quantity</li>
            <li>This action cannot be undone</li>
          </ul>
        </div>
      </div>
    </div>
    @if (p2pOrder) {
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-slate-400">Expected Amount</span>
          <span class="text-white font-bold text-base">{{ p2pOrder.quantity | number:'1.2-6' }} {{
            p2pOrder.p2p_ad?.token_symbol }}</span>
        </div>
      </div>
    </div>
    }
  </div>
  <ng-template #footer>
    <div class="flex gap-3 pt-2">
      <button type="button" (click)="confirmPaymentReceived()"
        class="px-6 py-3.5 rounded-3xl bg-linear-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg cursor-pointer">
        <i class="pi pi-check"></i>
        <span>Yes, I Received {{ p2pOrder?.p2p_ad?.token_symbol }}</span>
      </button>
      <button type="button" (click)="closeConfirmReceivedDialog()"
        class="px-6 py-3 rounded-3xl bg-slate-700/50 hover:bg-slate-600/50 text-white font-semibold transition-all duration-200 cursor-pointer">
        Cancel
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Notify Token Sent Dialog -->
<p-dialog [(visible)]="showNotifyTokenDialog" [modal]="true" [closable]="true" [draggable]="false"
  [style]="{ width: '95vw', maxWidth: '450px', 'border-radius': '1.5rem' }">
  <ng-template #header>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-linear-to-r from-blue-500 to-blue-600 flex items-center justify-center">
        <i class="pi pi-send text-white text-lg"></i>
      </div>
      <span class="text-lg font-bold text-white">Notify Token Sent</span>
    </div>
  </ng-template>
  <div class="space-y-4 py-4">
    <div class="bg-blue-500/10 border-2 border-blue-500/30 rounded-3xl p-4">
      <div class="flex items-start gap-3">
        <i class="pi pi-info-circle text-blue-400 text-xl mt-0.5"></i>
        <div class="space-y-2">
          <p class="text-white font-semibold text-sm">Confirm Token notification:</p>
          <ul class="text-xs text-slate-300 space-y-1 list-disc list-inside">
            <li>This will notify the user that Token has been sent</li>
            <li>Make sure you have actually sent the Token</li>
            <li>The user will be able to confirm receipt</li>
          </ul>
        </div>
      </div>
    </div>

    @if (p2pOrder) {
    <div class="bg-slate-800/30 border border-slate-700/50 rounded-3xl p-4">
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-slate-400">Token Amount</span>
          <span class="text-white font-bold text-base">{{ p2pOrder.quantity | number:'1.2-6' }} Token</span>
        </div>
        <div class="flex justify-between">
          <span class="text-slate-400">User</span>
          <span class="text-white font-semibold">{{ p2pOrder.ordered_by_user?.full_name || 'Unknown' }}</span>
        </div>
      </div>
    </div>
    }
  </div>
  <ng-template #footer>
    <div class="flex gap-3 pt-2">
      <button type="button" (click)="notifyTokenSent()"
        class="px-6 py-3.5 rounded-3xl bg-linear-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg cursor-pointer">
        <i class="pi pi-check"></i>
        <span>Yes, Notify User</span>
      </button>
      <button type="button" (click)="closeNotifyTokenDialog()"
        class="px-6 py-3 rounded-3xl bg-slate-700/50 hover:bg-slate-600/50 text-white font-semibold transition-all duration-200 cursor-pointer">
        Cancel
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Cancel Order Dialog -->
<p-dialog [(visible)]="showCancelOrderDialog" [modal]="true" [closable]="true" [draggable]="false"
  [style]="{ width: '95vw', maxWidth: '450px', 'border-radius': '1.5rem' }">
  <ng-template #header>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-linear-to-r from-red-500 to-red-600 flex items-center justify-center">
        <i class="pi pi-times-circle text-white text-lg"></i>
      </div>
      <span class="text-lg font-bold text-white">Cancel Order</span>
    </div>
  </ng-template>
  <div class="space-y-4 py-4">
    <div class="bg-red-500/10 border-2 border-red-500/30 rounded-3xl p-4">
      <div class="flex items-start gap-3">
        <i class="pi pi-exclamation-triangle text-red-400 text-xl mt-0.5"></i>
        <div class="space-y-2">
          <p class="text-white font-semibold text-sm">Are you sure you want to cancel this order?</p>
          <p class="text-xs text-slate-300">This action cannot be undone. The order will be permanently cancelled.</p>
        </div>
      </div>
    </div>
  </div>
  <ng-template #footer>
    <div class="flex gap-3 pt-2">
      <button type="button" (click)="cancelOrder()"
        class="px-6 py-3.5 rounded-3xl bg-linear-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg cursor-pointer">
        <i class="pi pi-times"></i>
        <span>Yes, Cancel</span>
      </button>
      <button type="button" (click)="closeCancelOrderDialog()"
        class="px-6 py-3 rounded-3xl bg-slate-700/50 hover:bg-slate-600/50 text-white font-semibold transition-all duration-200 cursor-pointer">
        Keep Order
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Image Preview Dialog -->
<p-dialog [(visible)]="showImagePreviewDialog" [modal]="true" [closable]="true" [draggable]="false"
  [style]="{ width: '95vw', maxWidth: '900px', 'border-radius': '1.5rem' }">
  <ng-template #header>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-linear-to-r from-blue-500 to-blue-600 flex items-center justify-center">
        <i class="pi pi-image text-white text-lg"></i>
      </div>
      <span class="text-lg font-bold text-white">Proof of Payment</span>
    </div>
  </ng-template>
  <div class="py-4">
    <div class="rounded-3xl overflow-hidden bg-slate-900/50 border border-purple-500/20">
      <img [src]="previewImageUrl" alt="Proof of payment preview" class="w-full h-auto max-h-[70vh] object-contain" />
    </div>
  </div>
  <ng-template #footer>
    <div class="flex gap-3 pt-2">
      <a [href]="previewImageUrl" target="_blank" download
        class="px-6 py-3.5 rounded-3xl bg-linear-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg cursor-pointer">
        <i class="pi pi-download"></i>
        <span>Download</span>
      </a>
      <button type="button" (click)="closeImagePreview()"
        class="px-6 py-3 rounded-3xl bg-slate-700/50 hover:bg-slate-600/50 text-white font-semibold transition-all duration-200 cursor-pointer">
        Close
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Toast -->
<p-toast />
